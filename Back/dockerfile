# Etapa 1: Construir a aplicação
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /app

# Copiar os arquivos do projeto
COPY GestaoEscalaPermutas.sln ./
COPY GestaoEscalaPermutas.Server/GestaoEscalaPermutas.Server.csproj ./GestaoEscalaPermutas.Server/
COPY GestaoEscalaPermutas.Dominio/GestaoEscalaPermutas.Dominio.csproj ./GestaoEscalaPermutas.Dominio/
COPY GestaoEscalaPermuta.Infra/GestaoEscalaPermutas.Infra.csproj ./GestaoEscalaPermuta.Infra/
COPY GestaoEscalaPermutas.Repository/GestaoEscalaPermutas.Repository.csproj ./GestaoEscalaPermutas.Repository/

# Restaurar as dependências
RUN dotnet restore

# Copiar o restante dos arquivos
COPY GestaoEscalaPermutas.Server/ ./GestaoEscalaPermutas.Server/
COPY GestaoEscalaPermutas.Dominio/ ./GestaoEscalaPermutas.Dominio/
COPY GestaoEscalaPermuta.Infra/ ./GestaoEscalaPermuta.Infra/
COPY GestaoEscalaPermutas.Repository/ ./GestaoEscalaPermutas.Repository/

# Copiar o certificado para dentro da imagem

COPY GestaoEscalaPermutas.Server/certificado.pfx /app/certificado.pfx


# Publicar a aplicação
WORKDIR /app/GestaoEscalaPermutas.Server
RUN dotnet publish -c Release -o out

# Etapa 2: Criar a imagem final
FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/GestaoEscalaPermutas.Server/out .

# Copiar o certificado para a imagem final
COPY --from=build /app/certificado.pfx /app/certificado.pfx


# Expor a porta corretamente
EXPOSE 8080

# Configurar permissões para o certificado (opcional, mas recomendado)
RUN chmod 644 /app/certificado.pfx


# Configurar permissões para o certificado (opcional, mas recomendado)
RUN chmod 644 /app/certificado.pfx

# Iniciar a aplicação
ENTRYPOINT ["dotnet", "GestaoEscalaPermutas.Server.dll"]